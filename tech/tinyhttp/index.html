<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.95.0"><meta name=theme-color content="#fff"><meta name=color-scheme content="light dark"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>æºç åˆ†æ-Tinyhttpé¡¹ç›® | SHVINQ</title><link rel=stylesheet href=/css/meme.min.css><script src=/js/meme.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&family=Cinzel+Decorative:wght@700&display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&family=Cinzel+Decorative:wght@700&display=swap"></noscript><meta name=author content="shvinq"><meta name=description content="Tinyhttpdæºç è§£æ Tinyhttpdæ˜¯J. David Blackstoneå†™çš„ä¸€ä¸ªè½»é‡å‹Http Serâ€¦â€¦"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=mask-icon href=/icons/safari-pinned-tab.svg color=#fff><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="SHVINQ"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="SHVINQ"><meta name=msapplication-starturl content="../../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../../icons/mstile-150x150.png"><link rel=manifest href=/manifest.json><link rel=canonical href=https://shvinq.com/tech/tinyhttp/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2021-10-01T07:13:58+08:00","dateModified":"2022-03-27T21:52:56+08:00","url":"https://shvinq.com/tech/tinyhttp/","headline":"æºç åˆ†æ-Tinyhttpé¡¹ç›®","description":"Tinyhttpdæºç è§£æ Tinyhttpdæ˜¯J. David Blackstoneå†™çš„ä¸€ä¸ªè½»é‡å‹Http Serâ€¦â€¦","inLanguage":"zh-CN","articleSection":"tech","wordCount":5727,"image":["https://tuchuang-1258133230.cos.ap-shanghai.myqcloud.com/EasTYuCfd8n1ki7.png","https://tuchuang-1258133230.cos.ap-shanghai.myqcloud.com/Q5dCI4EicpNeuoS.png","https://tuchuang-1258133230.cos.ap-shanghai.myqcloud.com/9G2ZODXWJiEAM4F.png"],"author":{"@type":"Person","description":"Go Deep","email":"zhoushuiqing321@gmail.com","image":"https://shvinq.com/icons/cool1.png","url":"https://shvinq.com/","name":"shvinq"},"license":"åœ¨ä¿ç•™æœ¬æ–‡ä½œè€…åŠæœ¬æ–‡é“¾æ¥çš„å‰æä¸‹ï¼Œéå•†ä¸šç”¨é€”éšæ„è½¬è½½åˆ†äº«ã€‚","publisher":{"@type":"Organization","name":"SHVINQ","logo":{"@type":"ImageObject","url":"https://shvinq.com/icons/cool1.png"},"url":"https://shvinq.com/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://shvinq.com/"}}</script><meta name=twitter:card content="summary_large_image"><meta property="og:title" content="æºç åˆ†æ-Tinyhttpé¡¹ç›®"><meta property="og:description" content="Tinyhttpdæºç è§£æ Tinyhttpdæ˜¯J. David Blackstoneå†™çš„ä¸€ä¸ªè½»é‡å‹Http Serâ€¦â€¦"><meta property="og:url" content="https://shvinq.com/tech/tinyhttp/"><meta property="og:site_name" content="SHVINQ"><meta property="og:locale" content="zh"><meta property="og:image" content="https://tuchuang-1258133230.cos.ap-shanghai.myqcloud.com/EasTYuCfd8n1ki7.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-10-01T07:13:58+08:00"><meta property="article:modified_time" content="2022-03-27T21:52:56+08:00"><meta property="article:section" content="tech"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap"></noscript></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=/ class=brand>SHVINQ</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon life"><path d="M301.1 212c4.4 4.4 4.4 11.9.0 16.3l-9.7 9.7c-4.4 4.7-11.9 4.7-16.6.0l-10.5-10.5c-4.4-4.7-4.4-11.9.0-16.6l9.7-9.7c4.4-4.4 11.9-4.4 16.6.0l10.5 10.8zm-30.2-19.7c3-3 3-7.8.0-10.5-2.8-3-7.5-3-10.5.0-2.8 2.8-2.8 7.5.0 10.5 3.1 2.8 7.8 2.8 10.5.0zm-26 5.3c-3 2.8-3 7.5.0 10.2 2.8 3 7.5 3 10.5.0 2.8-2.8 2.8-7.5.0-10.2-3-3-7.7-3-10.5.0zm72.5-13.3c-19.9-14.4-33.8-43.2-11.9-68.1 21.6-24.9 40.7-17.2 59.8.8 11.9 11.3 29.3 24.9 17.2 48.2-12.5 23.5-45.1 33.2-65.1 19.1zm47.7-44.5c-8.9-10-23.3 6.9-15.5 16.1 7.4 9 32.1 2.4 15.5-16.1zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-66.2 42.6c2.5-16.1-20.2-16.6-25.2-25.7-13.6-24.1-27.7-36.8-54.5-30.4 11.6-8 23.5-6.1 23.5-6.1.3-6.4.0-13-9.4-24.9 3.9-12.5.3-22.4.3-22.4 15.5-8.6 26.8-24.4 29.1-43.2 3.6-31-18.8-59.2-49.8-62.8-22.1-2.5-43.7 7.7-54.3 25.7-23.2 40.1 1.4 70.9 22.4 81.4-14.4-1.4-34.3-11.9-40.1-34.3-6.6-25.7 2.8-49.8 8.9-61.4.0.0-4.4-5.8-8-8.9.0.0-13.8.0-24.6 5.3 11.9-15.2 25.2-14.4 25.2-14.4.0-6.4-.6-14.9-3.6-21.6-5.4-11-23.8-12.9-31.7 2.8.1-.2.3-.4.4-.5-5 11.9-1.1 55.9 16.9 87.2-2.5 1.4-9.1 6.1-13 10-21.6 9.7-56.2 60.3-56.2 60.3-28.2 10.8-77.2 50.9-70.6 79.7.3 3 1.4 5.5 3 7.5-2.8 2.2-5.5 5-8.3 8.3-11.9 13.8-5.3 35.2 17.7 24.4 15.8-7.2 29.6-20.2 36.3-30.4.0.0-5.5-5-16.3-4.4 27.7-6.6 34.3-9.4 46.2-9.1 8 3.9 8-34.3 8-34.3.0-14.7-2.2-31-11.1-41.5 12.5 12.2 29.1 32.7 28 60.6-.8 18.3-15.2 23-15.2 23-9.1 16.6-43.2 65.9-30.4 106 0 0-9.7-14.9-10.2-22.1-17.4 19.4-46.5 52.3-24.6 64.5 26.6 14.7 108.8-88.6 126.2-142.3 34.6-20.8 55.4-47.3 63.9-65 22 43.5 95.3 94.5 101.1 59z"/></svg><span class=menu-item-name>ç”Ÿæ´»</span></a></li><li class="menu-item active"><a href=/tech/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tech"><path d="M512 256c0 141.2-114.7 256-256 256C114.8 512 0 397.3.0 256S114.7.0 256 0s256 114.7 256 256zm-32 0c0-123.2-100.3-224-224-224C132.5 32 32 132.5 32 256s100.5 224 224 224 224-100.5 224-224zM160.9 124.6l86.9 37.1-37.1 86.9-86.9-37.1 37.1-86.9zm110 169.1 46.6 94h-14.6l-50-1e2-48.9 1e2h-14l51.1-106.9-22.3-9.4 6-14 68.6 29.1-6 14.3-16.5-7.1zm-11.8-116.3 68.6 29.4-29.4 68.3L230 246l29.1-68.6zm80.3 42.9 54.6 23.1-23.4 54.3-54.3-23.1 23.1-54.3z"/></svg><span class=menu-item-name>æŠ€æœ¯</span></a></li><li class=menu-item><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon about"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6.0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7.0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4.0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9s28-2.7 40.9-6.9c2.3-.7 4.7-1.1 7.1-1.1 42.9.0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class=menu-item-name>å…³äº</span></a></li><li class=menu-item><a id=theme-switcher href=#><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒš</span></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=justify data-type=tech data-toc-num=true><h1 class="post-title p-name">æºç åˆ†æ-Tinyhttpé¡¹ç›®</h1><div class="post-body e-content"><h3 id=tinyhttpdæºç è§£æ><a href=#tinyhttpdæºç è§£æ class=anchor-link>#</a>Tinyhttpdæºç è§£æ</h3><p>Tinyhttpdæ˜¯J. David Blackstoneå†™çš„ä¸€ä¸ªè½»é‡å‹Http Serverç¨‹åºï¼Œé‡Œé¢åŒ…å«äº†socketç¼–ç¨‹ã€å¤šçº¿ç¨‹ç¼–ç¨‹ç­‰çŸ¥è¯†ï¼Œå€¼å¾—å­¦ä¹ ä¸€ä¸‹ã€‚</p><p><a href=https://github.com/EZLippi/Tinyhttpd target=_blank rel=noopener>Tinyhttpæºç Githubä¸‹è½½</a></p><p><code>Tinyhttpd</code>è¿è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src=https://tuchuang-1258133230.cos.ap-shanghai.myqcloud.com/EasTYuCfd8n1ki7.png alt=image.png></p><p><strong>æ•´ä½“å·¥ä½œè¿‡ç¨‹ï¼š</strong></p><p>1.å¯åŠ¨æœåŠ¡å™¨ï¼Œå¯ä»¥æŒ‡å®šæˆ–éšæœºé€‰å–ç«¯å£è¿›è¡Œå¯åŠ¨ï¼Œè°ƒç”¨startuå‡½æ•°åˆ›å»ºæœåŠ¡ç«¯socketã€‚</p><p>2.å½“æ”¶åˆ°ä¸€ä¸ªhttpçš„è¿æ¥è¯·æ±‚æ—¶ï¼Œåˆ†é…ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨accept_requestå‡½æ•°å»å¤„ç†è¯¥è¯·æ±‚ã€‚</p><p>3.è§£æhttpè¯·æ±‚æ¶ˆæ¯æ¥è·å–è¯·æ±‚æ–¹æ³•methodå’Œè¯·æ±‚çš„urlã€‚å¦‚æœæ˜¯GETæ–¹æ³•åˆ™é¢å¤–ä¿å­˜urlä¸­?åé¢çš„å‚æ•°ä¿¡æ¯</p><p>4.å°†æ ¼å¼åŒ–çš„urlå­˜å…¥pathå­—ç¬¦ä¸²ä¸­æ¥è¡¨ç¤ºæ­¤æ¬¡è¯·æ±‚æœåŠ¡å™¨çš„æ–‡ä»¶è·¯å¾„ï¼Œè¯¥tinyhttpdç¨‹åºçš„"/"ç›®å½•æ˜¯åœ¨htdpcsä¸‹ã€‚å¦‚æœå®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯æ˜¯ä»¥"/"ç»“å°¾æˆ–è€…è¯·æ±‚çš„æ˜¯ç›®å½•ï¼Œåˆ™åœ¨pathååŠ ä¸Šindex.htmlï¼Œè¡¨ç¤ºè®¿é—®ä¸»é¡µã€‚</p><p>5.å¦‚æœæ–‡ä»¶è·¯å¾„åˆæ³•ï¼Œå¯¹äºæ— å‚æ•°çš„GETè¯·æ±‚åˆ™ç›´æ¥è°ƒç”¨serve_fileå‡½æ•°å°†æ–‡ä»¶å†…å®¹å†™å…¥å®¢æˆ·ç«¯socketï¼›å…¶ä»–æƒ…å†µï¼ˆå¸¦å‚æ•° GETï¼ŒPOST æ–¹å¼ï¼Œurl ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œåˆ™è°ƒç”¨ excute_cgi å‡½æ•°æ‰§è¡Œ cgi è„šæœ¬ã€‚</p><p>6.å¦‚æœæ˜¯POSTæ–¹æ³•ï¼Œåˆ™éœ€è¦é¢å¤–è·å–Content-Lengthä¿¡æ¯</p><p>7.forkå‡ºå­è¿›ç¨‹å’Œåˆ›å»ºä¸¤ä¸ªç®¡é“cgi_inputå’Œcgi_outputç»™çˆ¶å­è¿›ç¨‹äº¤äº’ä¿¡æ¯</p><p>8.å­è¿›ç¨‹æ‰§è¡Œcgiè„šæœ¬ï¼Œå¹¶å°†å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ä¿®æ”¹é‡å®šå‘cgi_inputçš„è¯»å–ç«¯ï¼Œæ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°cgi_outputçš„å†™å…¥ç«¯ï¼›å¦å¤–å¯¹äºGETæ–¹æ³•åˆ™è®¾ç½®request_methodçš„ç¯å¢ƒå˜é‡ï¼Œå¯¹äºPOSTåˆ™è®¾ç½®content-lengthç¯å¢ƒå˜é‡ã€‚è¯·è°ƒç”¨execlå‡½æ•°æ‰§è¡Œcgiè„šæœ¬ç¨‹åºæ¥æ›¿æ¢è¯¥å­è¿›ç¨‹ã€‚</p><p>9.çˆ¶è¿›ç¨‹å…³é—­ç®¡é“cgi_inputçš„è¯»å–ç«¯å’Œcgi_outputçš„å†™å…¥ç«¯ã€‚å½“è¯·æ±‚æ–¹å¼æ˜¯POSTæ—¶å°†ä»å®¢æˆ·ç«¯è·å–çš„ä¿¡æ¯é€šè¿‡ç®¡é“cgi_input[1]å‘å­è¿›ç¨‹å†™å…¥ï¼Œæ­¤æ—¶æ˜¯å†™å…¥åˆ°äº†å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ï¼›ç„¶åé€šè¿‡cgi_output[0]ç®¡é“ä»å­è¿›ç¨‹è¯»å–æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶æ˜¯ä»å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºè¯»å–çš„ã€‚æœ€åå…³é—­ç®¡é“ï¼Œç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚</p><p>æºç é˜…è¯»é¡ºåºï¼š main -> startup -> accept_request -> execute_cgiã€‚</p><h4 id=1httpçš„getpostè¯·æ±‚æ¶ˆæ¯æ ¼å¼><a href=#1httpçš„getpostè¯·æ±‚æ¶ˆæ¯æ ¼å¼ class=anchor-link>#</a>1.Httpçš„GET/POSTè¯·æ±‚æ¶ˆæ¯æ ¼å¼</h4><p><img src=https://tuchuang-1258133230.cos.ap-shanghai.myqcloud.com/Q5dCI4EicpNeuoS.png alt=image.png></p><p>æ ‡å‡†GETè¯·æ±‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>192.168.0.1:47310</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>keep-alive</span>
</span></span><span class=line><span class=cl><span class=err>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>GET / HTTP/1.1\r\nHost: www.sina.com.cn\r\nConnection: close\r\n\r\n
</span></span></span></code></pre></div><p>æ ‡å‡†POSTè¯·æ±‚â€‹</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>POST / myhttpd.cgi HTTP / 1.1
</span></span></span><span class=line><span class=cl><span class=err>Host: 192.168.0.1 : 47310
</span></span></span><span class=line><span class=cl><span class=err>Connection : keep - alive
</span></span></span><span class=line><span class=cl><span class=err>Content - Length : 10
</span></span></span><span class=line><span class=cl><span class=err>...
</span></span></span><span class=line><span class=cl><span class=err>Form Data
</span></span></span></code></pre></div><h4 id=2mainå‡½æ•°><a href=#2mainå‡½æ•° class=anchor-link>#</a>2.Mainå‡½æ•°</h4><p>ä»¥ä¸‹æ˜¯<code>main</code>å‡½æ•°ä»£ç å®ç°</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>server_sock</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>       <span class=c1>//åˆ›å»ºæœåŠ¡ç«¯å¥—æ¥å­—
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>u_short</span> <span class=n>port</span> <span class=o>=</span> <span class=mi>4000</span><span class=p>;</span>        <span class=c1>//å®šä¹‰ç«¯å£
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>client_sock</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>client_name</span><span class=p>;</span>     <span class=c1>//å®¢æˆ·ç«¯åœ°å€å˜é‡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>socklen_t</span>  <span class=n>client_name_len</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>client_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pthread_t</span> <span class=n>newthread</span><span class=p>;</span>        <span class=c1>//çº¿ç¨‹å˜é‡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>server_sock</span> <span class=o>=</span> <span class=n>startup</span><span class=p>(</span><span class=o>&amp;</span><span class=n>port</span><span class=p>);</span>       <span class=c1>//è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°startupï¼Œåˆå§‹åŒ–æœåŠ¡å™¨æ®µå¥—æ¥å­—
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;httpd running on port %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* ä¸€ç›´å¾ªç¯å¤„ç†æ–°è¿æ¥çš„åˆ°æ¥ï¼Œå¹¶åˆ›å»ºå¹¶åˆ†é…çº¿ç¨‹å»å¤„ç†è¯¥è¿æ¥ */</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>client_sock</span> <span class=o>=</span> <span class=n>accept</span><span class=p>(</span><span class=n>server_sock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>client_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;</span><span class=n>client_name_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>client_sock</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=n>error_die</span><span class=p>(</span><span class=s>&#34;accept&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=cm>/*åˆ›å»ºçº¿ç¨‹ï¼Œæ‰§è¡Œçº¿ç¨‹ä¸»å‡½æ•°accept_request(),å¹¶å°†è¿æ¥å¥—æ¥å­—ä¼ å…¥è¯¥å‡½æ•°*/</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>newthread</span> <span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>accept_request</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>intptr_t</span><span class=p>)</span><span class=n>client_sock</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>perror</span><span class=p>(</span><span class=s>&#34;pthread_create&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>server_sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>å‡½æ•°æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è°ƒç”¨startupå‡½æ•°åˆå§‹åŒ–ä¸€ä¸ªæœåŠ¡å™¨socket</li><li>è¿›å…¥å¾ªç¯ï¼Œé€šè¿‡accepå‡½æ•°æ¥å—ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚</li><li>å¦‚æœæ¥æ”¶åˆ°æ–°è¯·æ±‚åœ¨è°ƒç”¨pthread_createå»ºç«‹æ–°çº¿ç¨‹</li><li>çº¿ç¨‹ä¸­è°ƒç”¨accept_requestå‡½æ•°ï¼Œå¤„ç†è¯·æ±‚</li></ol><p>ä¸‹æ–‡ä¼šåˆ†æstartupå‡½æ•°ï¼Œè¿™é‡Œåˆ†æä¸‹acceptå‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>accept</span><span class=p>(</span><span class=n>server_sock</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>client_name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>client_name_len</span><span class=p>);</span>
</span></span></code></pre></div><p>è¯¥å‡½æ•°æ¥å—ä¸€ä¸ªå¥—æ¥å­—ã€ipv4åœ°å€ç»“æ„å˜é‡æŒ‡é’ˆä»¥åŠå¯¹åº”é•¿åº¦ï¼Œå‡½æ•°è¿”å›æ˜¯æ–°çš„è¿æ¥å¥—æ¥å­—ï¼ŒCSç«¯é€šè¿‡å…¶é€šä¿¡ã€‚</p><p><code>accept</code>å‡½æ•°æœ‰ä¸¤ä¸ªé‡è¦ç‰¹ç‚¹ï¼š</p><ol><li>å¦‚æœæ²¡æœ‰ <code>connect</code> è¯·æ±‚ï¼Œå‡½æ•°è°ƒç”¨ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ¥æ”¶åˆ° <code>connect</code> è¯·æ±‚</li><li>åœ¨ä¸å®¢æˆ·ç«¯çš„å¥—æ¥å­—å»ºç«‹è¿æ¥æ—¶ï¼Œ<code>accept</code> å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„å¥—æ¥å­—ï¼Œå¹¶ç”¨æ–°çš„å¥—æ¥å­—ä¸å®¢æˆ·ç«¯è¿æ¥ï¼ŒåŸå§‹çš„å¥—æ¥å­—ä¾ç„¶å¤„äºæ‰“å¼€çŠ¶æ€ï¼Œå¯ä»¥ç”¨äºç»§ç»­ç›‘å¬ç«¯å£ã€‚</li></ol><h4 id=3å¥—æ¥å­—åˆå§‹åŒ–å‡½æ•°startup><a href=#3å¥—æ¥å­—åˆå§‹åŒ–å‡½æ•°startup class=anchor-link>#</a>3.å¥—æ¥å­—åˆå§‹åŒ–å‡½æ•°startup</h4><p>åŸå§‹ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>startup</span><span class=p>(</span><span class=n>u_short</span> <span class=o>*</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>httpd</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>on</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>httpd</span> <span class=o>=</span> <span class=n>socket</span><span class=p>(</span><span class=n>PF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>httpd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=n>error_die</span><span class=p>(</span><span class=s>&#34;socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>name</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=n>htons</span><span class=p>(</span><span class=o>*</span><span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=n>htonl</span><span class=p>(</span><span class=n>INADDR_ANY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>   
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*æ­¤å¤„è°ƒç”¨setsockoptæ–¹æ³•ï¼ŒSO_REUSEADDRå‚æ•°è¡¨ç¤ºå…è®¸é‡ç”¨æœ¬åœ°åœ°å€å’Œç«¯å£*/</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>httpd</span><span class=p>,</span> <span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>on</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>on</span><span class=p>)))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>error_die</span><span class=p>(</span><span class=s>&#34;setsockopt failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>bind</span><span class=p>(</span><span class=n>httpd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>name</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>name</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=n>error_die</span><span class=p>(</span><span class=s>&#34;bind&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>port</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>  <span class=cm>/* if dynamically allocating a port */</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>socklen_t</span> <span class=n>namelen</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*è°ƒç”¨ getsockname()è·å–ç³»ç»Ÿç»™ httpd éšæœºåˆ†é…çš„ç«¯å£å·*/</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>getsockname</span><span class=p>(</span><span class=n>httpd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>namelen</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>error_die</span><span class=p>(</span><span class=s>&#34;getsockname&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=n>port</span> <span class=o>=</span> <span class=n>ntohs</span><span class=p>(</span><span class=n>name</span><span class=p>.</span><span class=n>sin_port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>listen</span><span class=p>(</span><span class=n>httpd</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=n>error_die</span><span class=p>(</span><span class=s>&#34;listen&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>(</span><span class=n>httpd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>åˆå§‹åŒ–æµç¨‹æ¯”è¾ƒç®€å•ï¼Œå¤§å¤šæ˜¯å›ºå®šçš„ä»£ç ï¼š</p><ol><li>è°ƒç”¨ <code>socket</code> å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªä¸€å¥—æ¥å­—</li><li>åˆ›å»º <code>sockaddr_in</code> ç»“æ„ä½“ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„ ip å’Œ ç«¯å£</li><li>é€šè¿‡ <code>bind</code> å‡½æ•°ï¼Œç»‘å®šå¥—æ¥å­—çš„ ip å’Œ ç«¯å£</li><li>è°ƒç”¨ <code>listen</code> å‡½æ•°ï¼Œç›‘å¬è¯·æ±‚</li></ol><p>å…¶ä¸­å…·ä½“åˆ†æå†™<code>sockaddr_in</code>ç»“æ„ä½“ï¼Œä¸»è¦åŒ…å«äº†åœ°å€å’Œç«¯å£ä¿¡æ¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>in_addr</span> <span class=p>{</span>                <span class=cm>/* IPv4 4-byte address */</span>
</span></span><span class=line><span class=cl>    <span class=n>in_addr_t</span> <span class=n>s_addr</span><span class=p>;</span>           <span class=cm>/* Unsigned 32-bit integer */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=p>{</span>            <span class=cm>/* IPv4 socket address */</span>
</span></span><span class=line><span class=cl>    <span class=n>sa_family_t</span>    <span class=n>sin_family</span><span class=p>;</span>  <span class=cm>/* Address family (AF_INET) */</span>
</span></span><span class=line><span class=cl>    <span class=n>in_port_t</span>      <span class=n>sin_port</span><span class=p>;</span>    <span class=cm>/* Port number */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>in_addr</span> <span class=n>sin_addr</span><span class=p>;</span>    <span class=cm>/* IPv4 address */</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span>  <span class=n>__pad</span><span class=p>[</span><span class=n>X</span><span class=p>];</span>    <span class=cm>/* Pad to size of &#39;sockaddr&#39;
</span></span></span><span class=line><span class=cl><span class=cm>};                                 structure (16 bytes) */</span>
</span></span></code></pre></div><p>æ¥ä¸‹æ¥startupå‡½æ•°è°ƒç”¨<code>setsocket</code>å‡½æ•°ï¼Œè®¾ç½®å¥—æ¥å­—çš„ä¸€äº›å±æ€§ï¼Œå…¶ä¸­SO_REUSEADDRæ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„é€‰é¡¹å‚æ•°ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>setsockopt</span><span class=p>(</span><span class=n>httpd</span><span class=p>,</span> <span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>on</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>on</span><span class=p>))</span>
</span></span></code></pre></div><p>ä¸€èˆ¬æœåŠ¡å™¨çš„ç›‘å¬socketéƒ½åº”è¯¥æ‰“å¼€å®ƒã€‚å…¶å…è®¸æœåŠ¡å™¨bindä¸€ä¸ªåœ°å€ï¼Œå³ä½¿è¿™ä¸ªåœ°å€å½“å‰å·²ç»å­˜åœ¨å·²å»ºç«‹çš„è¿æ¥ï¼Œæ¯”å¦‚ï¼š</p><ul><li>æœåŠ¡å™¨å¯åŠ¨åï¼Œæœ‰å®¢æˆ·ç«¯è¿æ¥å¹¶å·²å»ºç«‹ï¼Œå¦‚æœæœåŠ¡å™¨ä¸»åŠ¨å…³é—­ï¼Œé‚£ä¹ˆå’Œå®¢æˆ·ç«¯çš„è¿æ¥ä¼šå¤„äºTIME_WAITçŠ¶æ€ï¼Œæ­¤æ—¶å†æ¬¡å¯åŠ¨æœåŠ¡å™¨ï¼Œå°±ä¼šbindä¸æˆåŠŸï¼ŒæŠ¥ï¼šAddress already in useã€‚</li><li>æœåŠ¡å™¨çˆ¶è¿›ç¨‹ç›‘å¬å®¢æˆ·ç«¯ï¼Œå½“å’Œå®¢æˆ·ç«¯å»ºç«‹é“¾æ¥åï¼Œforkä¸€ä¸ªå­è¿›ç¨‹ä¸“é—¨å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¦‚æœçˆ¶è¿›ç¨‹åœæ­¢ï¼Œå› ä¸ºå­è¿›ç¨‹è¿˜å’Œå®¢æˆ·ç«¯æœ‰è¿æ¥ï¼Œæ‰€ä»¥å†æ¬¡å¯åŠ¨çˆ¶è¿›ç¨‹ï¼Œä¹Ÿä¼šæŠ¥Address already in useã€‚</li></ul><p>åœ¨ TCP è¿æ¥ä¸­ï¼Œå½“ç«¯å£æ”¶åˆ°æˆ–è€…å‘é€ FIN/ACK è¯·æ±‚åï¼Œç«¯å£å¹¶ä¸ä¼šç«‹å³é‡Šæ”¾ï¼Œè€Œæ˜¯å¤„äº <code>TIME_WAIT</code> çŠ¶æ€ï¼ˆè¯¥çŠ¶æ€ä¸€èˆ¬æŒç»­ 2 åˆ†é’Ÿï¼‰ï¼Œæ­¤æ—¶ç«¯å£æ˜¯æ— æ³•ä¸å¥—æ¥å­—ç»‘å®šçš„ã€‚è®¾ç½® <code>SO_REUSEADDR</code> å¯ä»¥è®©å¥—æ¥å­—ç»‘å®šå¤„äº <code>TIME_WAIT</code> çŠ¶æ€çš„ç«¯å£ã€‚å…·ä½“åˆ†æå¯å‚è€ƒã€ŠTCP/IPè¯¦è§£ã€‹</p><p>æœ€åè°ƒç”¨<code>listen</code>å‡½æ•°ï¼Œè®©å¥—æ¥å­—è¿›å…¥è¢«åŠ¨ç›‘å¬çŠ¶æ€ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>listen</span><span class=p>(</span><span class=n>httpd</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>		
</span></span></code></pre></div><p>å…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°5ä»£è¡¨è¯·æ±‚é˜Ÿåˆ—çš„é•¿åº¦ã€‚</p><blockquote><p>å½“å¥—æ¥å­—æ­£åœ¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œå¦‚æœæœ‰æ–°çš„è¯·æ±‚è¿›æ¥ï¼Œå¥—æ¥å­—æ˜¯æ²¡æ³•å¤„ç†çš„ï¼Œåªèƒ½æŠŠå®ƒæ”¾è¿›ç¼“å†²åŒºï¼Œå¾…å½“å‰è¯·æ±‚å¤„ç†å®Œæ¯•åï¼Œå†ä»ç¼“å†²åŒºä¸­è¯»å–å‡ºæ¥å¤„ç†ã€‚å¦‚æœä¸æ–­æœ‰æ–°çš„è¯·æ±‚è¿›æ¥ï¼Œå®ƒä»¬å°±æŒ‰ç…§å…ˆåé¡ºåºåœ¨ç¼“å†²åŒºä¸­æ’é˜Ÿï¼Œç›´åˆ°ç¼“å†²åŒºæ»¡ã€‚è¿™ä¸ªç¼“å†²åŒºï¼Œå°±ç§°ä¸ºè¯·æ±‚é˜Ÿåˆ—ï¼ˆRequest Queueï¼‰ã€‚</p></blockquote><h4 id=4è¯·æ±‚æ¶ˆæ¯è§£æå‡½æ•°accept_request><a href=#4è¯·æ±‚æ¶ˆæ¯è§£æå‡½æ•°accept_request class=anchor-link>#</a>4.è¯·æ±‚æ¶ˆæ¯è§£æå‡½æ•°accept_request</h4><p>å‡½æ•°æºä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>accept_request</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>client</span> <span class=o>=</span> <span class=p>(</span><span class=n>intptr_t</span><span class=p>)</span><span class=n>arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>         <span class=c1>//æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯çš„ç¼“å†²åŒº
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>size_t</span> <span class=n>numchars</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>method</span><span class=p>[</span><span class=mi>255</span><span class=p>];</span>       <span class=c1>//è·å–å®¢æˆ·ç«¯çš„è¯·æ±‚æ–¹å¼
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span> <span class=n>url</span><span class=p>[</span><span class=mi>255</span><span class=p>];</span>          <span class=c1>//è·å–å®¢æˆ·ç«¯è¯·æ±‚çš„URL
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span> <span class=n>path</span><span class=p>[</span><span class=mi>512</span><span class=p>];</span>         <span class=c1>//è·å–å®¢æˆ·ç«¯è¯·æ±‚çš„è·¯å¾„
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>size_t</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>st</span><span class=p>;</span>         <span class=c1>//ç”¨æ¥å­˜å‚¨æ–‡ä»¶çŠ¶æ€çš„ç»“æ„ä½“
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>cgi</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>      		<span class=c1>//CGIç¨‹åºè°ƒç”¨æ ‡è®°
</span></span></span><span class=line><span class=cl><span class=c1></span>                      
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>query_string</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*httpæ¶ˆæ¯ä¸­ä¸€è¡Œï¼Œnumcharsè¡¨ç¤ºè¿™è¡Œä¿¡æ¯çš„ç»“å°¾åœ¨bufä¸­çš„ä½ç½®*/</span>
</span></span><span class=line><span class=cl>    <span class=n>numchars</span> <span class=o>=</span> <span class=n>get_line</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>      
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>ISspace</span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>method</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>buf</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>         <span class=c1>//ç”¨methodæ¥è¡¨ç¤ºè¯·æ±‚æ–¹å¼
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>j</span><span class=o>=</span><span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*æ­¤å¤„åˆ¤æ–­æ–¹æ³•æ˜¯å¦æ”¯æŒè§£ææˆ–è€…æ–¹æ³•æ˜¯å¦æ­£å¸¸ï¼Œä¸æ”¯æŒåˆ™è°ƒç”¨unimplementedå‡½æ•°è¿”å›é”™è¯¯æ–¹æ³•çš„å“åº”æ¶ˆæ¯ç»™å®¢æˆ·ç«¯å¹¶é€€å‡ºè§£æç»“æŸçº¿ç¨‹*/</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=s>&#34;GET&#34;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=s>&#34;POST&#34;</span><span class=p>))</span>        
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>unimplemented</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*å¦‚æœæ˜¯postæ–¹æ³•ï¼Œåˆ™å°†è°ƒç”¨cgiå‡½æ•°çš„æ ‡è®°ç½®ä¸ºtrue*/</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=s>&#34;POST&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=n>cgi</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>ISspace</span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>j</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>&lt;</span> <span class=n>numchars</span><span class=p>))</span> <span class=n>j</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/*ç»§ç»­å¾€åç§»åŠ¨jæ¥è·å–urlä¿¡æ¯ä½œä¸ºå­—ç¬¦ä¸²*/</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>ISspace</span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>j</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>url</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>&lt;</span> <span class=n>numchars</span><span class=p>))</span>     
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>url</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>buf</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span><span class=o>++</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*æ¯”è¾ƒmethodå­—ç¬¦ä¸²å’Œ&#34;GET&#34;æ˜¯å¦ç›¸åŒï¼Œç›¸åŒè¿”å›0ï¼Œå¤§äºè¿”å›æ­£å€¼ï¼Œåæ­£è¿”å›è´Ÿå€¼ã€‚æ­¤å¤„æ˜¯å¤„ç†GETæ–¹æ³•*/</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=s>&#34;GET&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*ç”¨query_stringæ¥è·å–?åé¢çš„GETè¯·æ±‚çš„å‚æ•°*/</span>
</span></span><span class=line><span class=cl>        <span class=n>query_string</span> <span class=o>=</span> <span class=n>url</span><span class=p>;</span>                     
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>((</span><span class=o>*</span><span class=n>query_string</span> <span class=o>!=</span> <span class=sc>&#39;?&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>*</span><span class=n>query_string</span> <span class=o>!=</span> <span class=sc>&#39;\0&#39;</span><span class=p>))</span> <span class=n>query_string</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=cm>/*å¦‚æœæœ‰å‚æ•°åˆ™å°†cgiæ ‡è®°ç½®ä¸ºtrueï¼Œæ­¤æ—¶query_stringæŒ‡å‘äº†?åé¢çš„GETå‚æ•°*/</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>query_string</span> <span class=o>==</span> <span class=sc>&#39;?&#39;</span><span class=p>)</span>       
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cgi</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=n>query_string</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>query_string</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*å°†å­—ç¬¦ä¸²&#34;htdoc&#34;ä¸å­—ç¬¦ä¸²urlè¿›è¡Œæ‹¼æ¥ï¼Œå¹¶ä¿å­˜åœ¨pathå˜é‡ä¸­*/</span>
</span></span><span class=line><span class=cl>    <span class=n>sprintf</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s>&#34;htdocs%s&#34;</span><span class=p>,</span> <span class=n>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=cm>/*å¦‚æœæ­¤æ—¶pathæ˜¯ä»¥&#34;/&#34;ç»“å°¾ï¼Œåˆ™å°†å­—ç¬¦ä¸²&#34;index.html&#34;è¿½åŠ åˆ°pathåé¢*/</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>path</span><span class=p>[</span><span class=n>strlen</span><span class=p>(</span><span class=n>path</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;/&#39;</span><span class=p>)</span> <span class=n>strcat</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s>&#34;index.html&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* è°ƒç”¨statå‡½æ•°ï¼Œé€šè¿‡pathä¸­çš„æ–‡ä»¶è·¯å¾„è·å–æ–‡ä»¶æˆ–æ–‡ä»¶è·¯å¾„ä¿¡æ¯ï¼Œå¹¶ä¿å­˜åˆ°struct stat stä¸­ */</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>stat</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>st</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*stat()å‡½æ•°æ‰§è¡Œå¤±è´¥è¿”å›-1ï¼Œå¤„ç†å¹¶ä¸¢å¼ƒå‰©ä¸‹çš„è¯·æ±‚å¤´å¹¶è¿”å›é”™è¯¯ä¿¡æ¯*/</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>((</span><span class=n>numchars</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>strcmp</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>))</span>  <span class=cm>/* read &amp; discard headers */</span>
</span></span><span class=line><span class=cl>            <span class=n>numchars</span> <span class=o>=</span> <span class=n>get_line</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>not_found</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*å¦‚æœæ–‡ä»¶è·¯å¾„åˆæ³•ï¼Œå¯¹äºæ— å‚æ•°çš„ GET è¯·æ±‚ï¼Œç›´æ¥å°†æ–‡ä»¶å†…å®¹å†™å…¥å®¢æˆ·ç«¯å¥—æ¥å­—ã€‚å…¶ä»–æƒ…å†µï¼ˆå¸¦å‚æ•°GETï¼ŒPOST æ–¹å¼ï¼Œurl ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œåˆ™è°ƒç”¨ excute_cgi å‡½æ•°æ‰§è¡Œ cgi è„šæœ¬*/</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>st</span><span class=p>.</span><span class=n>st_mode</span> <span class=o>&amp;</span> <span class=n>S_IFMT</span><span class=p>)</span> <span class=o>==</span> <span class=n>S_IFDIR</span><span class=p>)</span> <span class=n>strcat</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s>&#34;/index.html&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>st</span><span class=p>.</span><span class=n>st_mode</span> <span class=o>&amp;</span> <span class=n>S_IXUSR</span><span class=p>)</span><span class=o>||</span><span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=n>st_mode</span> <span class=o>&amp;</span> <span class=n>S_IXGRP</span><span class=p>)</span><span class=o>||</span><span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=n>st_mode</span> <span class=o>&amp;</span> <span class=n>S_IXOTH</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>cgi</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>   <span class=cm>/*ç®€å•çš„GETè¯·æ±‚ä¸”ï¼Ÿåæ— å‚æ•°æ—¶ï¼Œä¸æ‰§è¡Œcgiå‡½æ•°ï¼Œè€Œæ˜¯è°ƒç”¨serve_fileå‡½æ•°å°†å®¢æˆ·ç«¯è¯·æ±‚çš„æ–‡ä»¶å‘é€ç»™å®¢æˆ·ç«¯*/</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cgi</span><span class=p>)</span> <span class=n>serve_file</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>   <span class=cm>/*æ‰§è¡Œcgiå‡½æ•°ï¼Œå°†è¿æ¥å¥—æ¥å­—ï¼Œæ–‡ä»¶è·¯å¾„ï¼Œè¯·æ±‚æ–¹å¼å’Œ?åçš„GETå‚æ•°ä¼ å…¥ã€‚*/</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=n>execute_cgi</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>method</span><span class=p>,</span> <span class=n>query_string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>accept_request</code> å‡½æ•°ä¸»è¦æ¶‰åŠçš„æ˜¯å¯¹äº request header çš„å¤„ç†ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æå– request çš„ç±»å‹ï¼ˆGET æˆ– POSTï¼‰</li><li>æå– url ä¿¡æ¯</li><li>å¦‚æœæ˜¯ GET è¯·æ±‚ï¼Œåˆ™æå– url ä¸­çš„å‚æ•°ä¿¡æ¯ï¼ˆ?ä¹‹åå‚æ•°ï¼‰</li><li>å¦‚æœ url ç»“å°¾æ˜¯ / æˆ–è€…è¯¥åœ°å€å¯¹åº”ä¸€ä¸ªç›®å½•ï¼Œé»˜è®¤è°ƒç”¨è¯¥ç›®å½•ä¸‹çš„ index.html</li><li>å¦‚æœä¸æ˜¯ CGIï¼Œåˆ™è°ƒç”¨ <code>serve_file</code>ï¼Œå°†æ–‡æœ¬å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯</li><li>å¦‚æœæ˜¯ CGIï¼Œè°ƒç”¨ <code>execute_cgi</code>ï¼Œæ‰§è¡Œ CGI è„šæœ¬ç¨‹åº</li><li>æ–­å¼€è¿æ¥</li></ol><p>åœ¨å¯¹ request header çš„å¤„ç†ä¸­ï¼Œå¤§é‡è°ƒç”¨äº† <code>get_line</code> å‡½æ•°ã€‚è¯¥å‡½æ•°ç”¨äºè¯»å–æ–‡ä»¶çš„ä¸‹ä¸€è¡Œä¿¡æ¯ï¼Œé€‚ç”¨äºä¸åŒçš„æ¢è¡Œç¬¦ï¼ˆ<code>\n</code> æˆ– <code>\r\n</code>ï¼‰ã€‚</p><p>è¯¥å‡½æ•°ä½¿ç”¨çš„<code>stat</code>å‡½æ•°ï¼Œç”¨äºè·å–æ–‡ä»¶æˆ–æ–‡ä»¶è·¯å¾„çŠ¶æ€ä¿¡æ¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>stat</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=k>struct</span> <span class=n>stat</span> <span class=o>*</span><span class=n>statbuf</span><span class=p>);</span>
</span></span></code></pre></div><p>å…¶ä¸­<code>stat</code>ç»“æ„ä½“å†…å®¹ä¿¡æ¯è¾ƒå¤šï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>stat</span>  
</span></span><span class=line><span class=cl><span class=p>{</span>   
</span></span><span class=line><span class=cl>    <span class=n>dev_t</span>       <span class=n>st_dev</span><span class=p>;</span>     <span class=cm>/* ID of device containing file -æ–‡ä»¶æ‰€åœ¨è®¾å¤‡çš„ID*/</span>  
</span></span><span class=line><span class=cl>    <span class=n>ino_t</span>       <span class=n>st_ino</span><span class=p>;</span>     <span class=cm>/* inode number -inodeèŠ‚ç‚¹å·*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>mode_t</span>      <span class=n>st_mode</span><span class=p>;</span>    <span class=cm>/* protection -ä¿æŠ¤æ¨¡å¼?*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>nlink_t</span>     <span class=n>st_nlink</span><span class=p>;</span>   <span class=cm>/* number of hard links -é“¾å‘æ­¤æ–‡ä»¶çš„è¿æ¥æ•°(ç¡¬è¿æ¥)*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>uid_t</span>       <span class=n>st_uid</span><span class=p>;</span>     <span class=cm>/* user ID of owner -user id*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>gid_t</span>       <span class=n>st_gid</span><span class=p>;</span>     <span class=cm>/* group ID of owner - group id*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>dev_t</span>       <span class=n>st_rdev</span><span class=p>;</span>    <span class=cm>/* device ID (if special file) -è®¾å¤‡å·ï¼Œé’ˆå¯¹è®¾å¤‡æ–‡ä»¶*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>off_t</span>       <span class=n>st_size</span><span class=p>;</span>    <span class=cm>/* total size, in bytes -æ–‡ä»¶å¤§å°ï¼Œå­—èŠ‚ä¸ºå•ä½*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>blksize_t</span>   <span class=n>st_blksize</span><span class=p>;</span> <span class=cm>/* blocksize for filesystem I/O -ç³»ç»Ÿå—çš„å¤§å°*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>blkcnt_t</span>    <span class=n>st_blocks</span><span class=p>;</span>  <span class=cm>/* number of blocks allocated -æ–‡ä»¶æ‰€å å—æ•°*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>time_t</span>      <span class=n>st_atime</span><span class=p>;</span>   <span class=cm>/* time of last access -æœ€è¿‘å­˜å–æ—¶é—´*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>time_t</span>      <span class=n>st_mtime</span><span class=p>;</span>   <span class=cm>/* time of last modification -æœ€è¿‘ä¿®æ”¹æ—¶é—´*/</span>    
</span></span><span class=line><span class=cl>    <span class=n>time_t</span>      <span class=n>st_ctime</span><span class=p>;</span>   <span class=cm>/* time of last status change - */</span>    
</span></span><span class=line><span class=cl><span class=p>};</span> 
</span></span></code></pre></div><h4 id=5cgiæ‰§è¡Œå‡½æ•°execute_cgi><a href=#5cgiæ‰§è¡Œå‡½æ•°execute_cgi class=anchor-link>#</a>5.CGIæ‰§è¡Œå‡½æ•°execute_cgi</h4><p>å‡½æ•°æºä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*å‚æ•°ä¸ºè¿æ¥å¥—æ¥å­—ï¼Œæ–‡ä»¶è·¯å¾„ï¼Œè¯·æ±‚æ–¹å¼å’Œ?åçš„GETå‚æ•°*/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>execute_cgi</span><span class=p>(</span><span class=kt>int</span> <span class=n>client</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>method</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>query_string</span><span class=p>)</span>       
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cgi_output</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cgi_input</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>pid_t</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>numchars</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>content_length</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>buf</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;A&#39;</span><span class=p>;</span> <span class=n>buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=cm>/*å¦‚æœæ˜¯GETè¯·æ±‚ï¼Œæ— é¡»å¤„ç†ä¸‹é¢çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ç»§ç»­æ‰§è¡Œå¤„ç†å¹¶ä¸¢å¼ƒå‰©ä¸‹çš„è¯·æ±‚å¤´ä¿¡æ¯*/</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=s>&#34;GET&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>     
</span></span><span class=line><span class=cl>    <span class=p>{</span>    <span class=k>while</span> <span class=p>((</span><span class=n>numchars</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>strcmp</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>))</span>  <span class=cm>/* read &amp; discard headers */</span>
</span></span><span class=line><span class=cl>            <span class=n>numchars</span> <span class=o>=</span> <span class=n>get_line</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=s>&#34;POST&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=cm>/*POSTæ–¹æ³•*/</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>numchars</span> <span class=o>=</span> <span class=n>get_line</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>      <span class=c1>//è·å–ä¸‹ä¸€è¡Œä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=p>((</span><span class=n>numchars</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>strcmp</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*å¦‚æœæ˜¯POSTè¯·æ±‚ï¼Œå°±éœ€è¦å¾—åˆ° Content-Length,content-Length å­—ç¬¦ä¸²é•¿åº¦ä¸º15ä» 17 ä½å¼€				  å§‹æ˜¯å…·ä½“çš„é•¿åº¦ä¿¡æ¯*/</span>
</span></span><span class=line><span class=cl>            <span class=n>buf</span><span class=p>[</span><span class=mi>15</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=s>&#34;Content-Length:&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>content_length</span> <span class=o>=</span> <span class=n>atoi</span><span class=p>(</span><span class=o>&amp;</span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=mi>16</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>numchars</span> <span class=o>=</span> <span class=n>get_line</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>content_length</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>bad_request</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=cm>/*HEAD or other*/</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*pipeç³»ç»Ÿè°ƒç”¨å»ºç«‹ç®¡é“*/</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>pipe</span><span class=p>(</span><span class=n>cgi_output</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cannot_execute</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>         <span class=c1>//è°ƒç”¨cannot_executeå‡½æ•°é€šçŸ¥å®¢æˆ·ç«¯æ— æ³•æ‰§è¡ŒCGIè„šæœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>pipe</span><span class=p>(</span><span class=n>cgi_input</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cannot_execute</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>pid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>())</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>         <span class=c1>//åˆ›å»ºå­è¿›ç¨‹æ‰§è¡ŒCGIè„šæœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>cannot_execute</span><span class=p>(</span><span class=n>client</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=s>&#34;HTTP/1.0 200 OK</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>        <span class=c1>//å‘é€200OKçŠ¶æ€ç ç»™å®¢æˆ·ç«¯
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>send</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>strlen</span><span class=p>(</span><span class=n>buf</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>  <span class=cm>/* child: CGI script */</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>meth_env</span><span class=p>[</span><span class=mi>255</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>query_env</span><span class=p>[</span><span class=mi>255</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>length_env</span><span class=p>[</span><span class=mi>255</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/*å¤åˆ¶cgi_output[1]æ–‡ä»¶æè¿°ç¬¦åˆ°æ ‡å‡†è¾“å‡ºï¼Œæ­¤æ—¶æ ‡å‡†è¾“å‡ºè¢«å…³é—­*/</span>
</span></span><span class=line><span class=cl>        <span class=n>dup2</span><span class=p>(</span><span class=n>cgi_output</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>STDOUT</span><span class=p>);</span>   
</span></span><span class=line><span class=cl>        <span class=cm>/*å¤åˆ¶cgi_input[0]æ–‡ä»¶æè¿°ç¬¦åˆ°æ ‡å‡†è¾“å…¥ï¼Œæ­¤æ—¶æ ‡å‡†è¾“å…¥è¢«å…³é—­*/</span>
</span></span><span class=line><span class=cl>        <span class=n>dup2</span><span class=p>(</span><span class=n>cgi_input</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>STDIN</span><span class=p>);</span>       
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>cgi_output</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>cgi_input</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=cm>/*å°†æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œä¿å­˜åˆ°meth_envä¸­*/</span>
</span></span><span class=line><span class=cl>        <span class=n>sprintf</span><span class=p>(</span><span class=n>meth_env</span><span class=p>,</span> <span class=s>&#34;REQUEST_METHOD=%s&#34;</span><span class=p>,</span> <span class=n>method</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=cm>/*è°ƒç”¨putenvå‡½æ•°å°†meth_envæ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­*/</span>
</span></span><span class=line><span class=cl>        <span class=n>putenv</span><span class=p>(</span><span class=n>meth_env</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/*å¦‚æœæ˜¯GETè¯·æ±‚ï¼Œå°†ï¼Ÿåé¢çš„å‚æ•°ä¹ŸåŠ å…¥ç¯å¢ƒå˜é‡*/</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=s>&#34;GET&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>sprintf</span><span class=p>(</span><span class=n>query_env</span><span class=p>,</span> <span class=s>&#34;QUERY_STRING=%s&#34;</span><span class=p>,</span> <span class=n>query_string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>putenv</span><span class=p>(</span><span class=n>query_env</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=cm>/*å¦‚æœæ˜¯POSTæ–¹æ³•ï¼Œå°†content-lengthåŠ å…¥ç¯å¢ƒå˜é‡*/</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=p>{</span>   <span class=cm>/* POST */</span>
</span></span><span class=line><span class=cl>            <span class=n>sprintf</span><span class=p>(</span><span class=n>length_env</span><span class=p>,</span> <span class=s>&#34;CONTENT_LENGTH=%d&#34;</span><span class=p>,</span> <span class=n>content_length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>putenv</span><span class=p>(</span><span class=n>length_env</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=cm>/*execå‡½æ•°æ—å¯åŠ¨ä¸€ä¸ªæ–°ç¨‹åºï¼Œæ›¿æ¢åŸæœ‰çš„è¿›ç¨‹ã€‚å› æ­¤è¿™ä¸ªæ–°çš„è¢«execæ‰§è¡Œçš„è¿›ç¨‹çš„PIDä¸ä¼šæ”¹å˜ï¼Œå’Œè°ƒç”¨execå‡½æ•°çš„è¿›ç¨‹ä¸€æ ·*/</span>
</span></span><span class=line><span class=cl>        <span class=n>execl</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>                                  
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥è¾“å‡ºå’Œcgi_inputå’Œcgi_outputç»‘å®šäº†ï¼Œçˆ¶è¿›ç¨‹å¯ä»¥é€šè¿‡ cgi_input å’Œ cgi_output è·å–å­è¿›ç¨‹ä¸­cgiè„šæœ¬çš„æ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡º*/</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>cgi_output</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>cgi_input</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=s>&#34;POST&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*æ ¹æ®Content-Lengthè¯»å–å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œå¹¶é€šè¿‡cgi_inputp[1]ç®¡é“ä¼ å…¥å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥*/</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>content_length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>recv</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>write</span><span class=p>(</span><span class=n>cgi_input</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*é€šè¿‡cgi_outputç®¡é“è·å–å­è¿›ç¨‹æ ‡å‡†è¾“å‡ºï¼Œå¹¶å†™å…¥åˆ°å®¢æˆ·ç«¯*/</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>cgi_output</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=n>send</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>cgi_output</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>cgi_input</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>waitpid</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>status</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>å‡½æ•°çš„æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å¯¹ POST è¯·æ±‚ï¼Œæ ¹æ® Content-Length æå– body ä¸­çš„ä¿¡æ¯</li><li>åˆ›å»ºä¸¤ä¸ªç®¡é“ cgi_input å’Œ cgi_output ç”¨äºè¿›ç¨‹é—´é€šä¿¡</li><li>è°ƒç”¨ <code>fork</code> å»ºç«‹å­è¿›ç¨‹</li><li>å­è¿›ç¨‹è°ƒç”¨ <code>dup2</code> å°†æ ‡å‡†è¾“å…¥ä¸æ ‡å‡†è¾“å‡ºåˆ†åˆ«é‡å®šå‘åˆ°å¯¹åº”ç®¡é“çš„è¯»ç«¯å’Œå†™ç«¯</li><li>åœ¨å­è¿›ç¨‹ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¹¶è°ƒç”¨ <code>execl</code>ï¼Œæ‰§è¡Œ CGI è„šæœ¬</li><li>çˆ¶è¿›ç¨‹é€šè¿‡ç®¡é“å‘ CGI è„šæœ¬ä¼ å…¥å‚æ•°ï¼Œå¹¶è·å–è„šæœ¬çš„è¿”å›ç»“æœï¼Œå†å°†ç»“æœä¼ ç»™å®¢æˆ·ç«¯</li><li>çˆ¶è¿›ç¨‹ç­‰å¾…å­ç»“æŸ</li></ol><p>è¿™é‡Œçš„é‡ç‚¹æ˜¯çˆ¶å­è¿›ç¨‹åˆ©ç”¨ç®¡é“å®ç°IPCã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>pipe</span><span class=p>(</span><span class=kt>int</span> <span class=n>filedes</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span></code></pre></div><p>è°ƒç”¨ <code>pipe</code> å‡½æ•°ï¼Œå¾—åˆ°ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ†åˆ«å¯¹åº”ç®¡é“çš„è¯»ç«¯ <code>filedes[0]</code> å’Œå†™ç«¯ <code>filedes[1]</code>ï¼Œå½“ç¨‹åºåœ¨å†™ç«¯å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è¯»ç«¯å¯ä»¥è¯»å–åˆ°å†™å…¥çš„æ•°æ®ã€‚æ¥ç€ï¼Œé€šè¿‡ <code>fork</code> å‡½æ•°ï¼Œå¾—åˆ°ä¸€ä¸ªå­è¿›ç¨‹ã€‚ç”±äºå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹æ‹¥æœ‰å®Œå…¨ç›¸åŒçš„å˜é‡ï¼Œå› æ­¤å­è¿›ç¨‹ä¹Ÿæœ‰å¯¹åº”ç®¡é“è¯»ç«¯å’Œå†™ç«¯çš„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚ä¹‹åï¼Œåªéœ€è¦å…³é—­ä¸€ä¾§çš„è¯»ç«¯å’Œå¦ä¸€ä¾§çš„å†™ç«¯ï¼Œå°±å¯ä»¥å®ç°è¿›ç¨‹é—´çš„é€šä¿¡ã€‚</p><p><img src=https://tuchuang-1258133230.cos.ap-shanghai.myqcloud.com/9G2ZODXWJiEAM4F.png alt=image.png></p><p>æ¥ä¸‹æ¥è°ƒç”¨<code>dup2</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¹å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥è¾“å‡ºè¿›è¡Œé‡å®šå‘ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>dup2</span><span class=p>(</span><span class=kt>int</span> <span class=n>oldfd</span><span class=p>,</span> <span class=kt>int</span> <span class=n>newfd</span><span class=p>);</span>  <span class=c1>//dup2å¯ä»¥ç”¨å‚æ•°newfdæŒ‡å®šæ–°æ–‡ä»¶æè¿°ç¬¦çš„æ•°å€¼ã€‚
</span></span></span></code></pre></div><p>è‹¥å‚æ•°newfdå·²ç»è¢«ç¨‹åºä½¿ç”¨ï¼Œåˆ™ç³»ç»Ÿå°±ä¼šå°†newfdæ‰€æŒ‡çš„æ–‡ä»¶å…³é—­ï¼Œè‹¥newfdç­‰äºoldfdï¼Œåˆ™è¿”å›newfd,è€Œä¸å…³é—­newfdæ‰€æŒ‡çš„æ–‡ä»¶ã€‚dup2æ‰€å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦ä¸åŸæ¥çš„æ–‡ä»¶æè¿°ç¬¦å…±äº«å„ç§æ–‡ä»¶çŠ¶æ€ã€å…±äº«æ‰€æœ‰çš„é”å®šã€è¯»å†™ä½ç½®å’Œå„é¡¹æƒé™æˆ–flagsç­‰</p><p>åœ¨è¿™é‡Œå®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li>å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºå°†ä¼šå†™å…¥åˆ° <code>cgi_output</code> çš„å†™ç«¯</li><li><code>cgi_input</code> è¯»ç«¯è¯»å–çš„æ•°æ®å°†ä¼šä½œä¸ºå­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥</li></ul><p>åœ¨å­è¿›ç¨‹å®Œæˆæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡ºçš„é‡å®šå‘ä¹‹åï¼Œè°ƒç”¨ <code>execl</code> å‡½æ•°ï¼Œæ‰§è¡Œ CGI è„šæœ¬ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>execl</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span></code></pre></div><p>è¯¥å‡½æ•°ä¼šè®©è¿›ç¨‹åŠ è½½æ–°çš„ç¨‹åºï¼Œä¹‹å‰çš„ç¨‹åºåŒ…æ‹¬ç¼“å­˜çš„æ•°æ®éƒ½ä¼šè¢«ä¸¢å¼ƒæ‰ã€‚æ­¤æ—¶ï¼Œå­è¿›ç¨‹å°±æ˜¯ CGI è„šæœ¬çš„æ‰§è¡Œç¨‹åºã€‚</p><p>çˆ¶è¿›ç¨‹åªéœ€è¦åšä¸¤ä»¶äº‹ï¼š</p><ul><li>è°ƒç”¨ <code>recv</code> å‡½æ•°ï¼Œä»å®¢æˆ·ç«¯ä¸­æ¥æ”¶æ•°æ®ï¼Œå¹¶å°†æ•°æ®é€šè¿‡ <code>cgi_input[1]</code> å†™å…¥ä¼ å…¥ CGI è„šæœ¬</li><li>ä» <code>cgi_output[0]</code> ä¸­è¯»å– CGI è„šæœ¬çš„è¿”å›ç»“æœï¼Œå¹¶è°ƒç”¨ <code>send</code> å‡½æ•°ï¼Œå°†ç»“æœå‘é€ç»™å®¢æˆ·ç«¯</li></ul><p>è¯¥Tinyhttpdçš„æºç ä¸»ä½“å·²ç»è§£æå®Œæ¯•ï¼Œå½“ç„¶è¿˜æœ‰è·å–ä¸€è¡Œä¿¡æ¯çš„get_line()ã€ä»æ–‡ä»¶è¯»å…¥å†…å®¹çš„cat()ç­‰å‡½æ•°ï¼Œé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œè¯»ä¸€éå¤§è‡´å°±ç†è§£äº†ï¼Œè¿™é‡Œå°±ä¸åŠ ä»¥èµ˜è¿°ã€‚</p></div></article><footer class=minimal-footer><div class=post-tag><a href=/tags/%E6%BA%90%E7%A0%81/ rel=tag class=post-tag-link>#æºç </a></div><div class=post-category><a href=/tech/ class="post-category-link active">tech</a> |</div></footer></div></main></div><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js")})</script><script src=/js/medium-zoom.min.js></script>
<script>mediumZoom(document.querySelectorAll("div.post-body img"),{background:"hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)"})</script></body></html>